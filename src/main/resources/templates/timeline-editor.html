<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Editor - Multi-Track Timeline</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/timeline.css">
</head>
<body>
    <div class="container">
        <header class="editor-header">
            <h1>üé¨ Video Editor</h1>
            <div class="header-controls">
                <button id="playBtn" class="btn btn-primary">‚ñ∂Ô∏è Play</button>
                <button id="stopBtn" class="btn btn-secondary">‚èπÔ∏è Stop</button>
                <button id="previewBtn" class="btn btn-secondary">üëÅÔ∏è Preview</button>
                <button id="renderBtn" class="btn btn-success">üé¨ Render</button>
                <a href="/" class="btn btn-secondary">‚Üê Back to Home</a>
            </div>
        </header>

        <div class="editor-layout">
            <!-- File Upload Area -->
            <div class="upload-section">
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-content">
                        <div class="upload-icon">üìÅ</div>
                        <h3>Upload Video/Audio Files</h3>
                        <p>Drag and drop files here or click to browse</p>
                        <input type="file" id="fileInput" multiple accept="video/*,audio/*" style="display: none;">
                        <button id="uploadBtn" class="btn btn-primary">Choose Files</button>
                    </div>
                </div>
                
                <div class="media-library" id="mediaLibrary" style="display: none;">
                    <h4>üìö Media Library</h4>
                    <div class="media-files" id="mediaFiles">
                        <!-- Media files will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Timeline Section -->
            <div class="timeline-section">
                <div class="timeline-header">
                    <h3>üéûÔ∏è Timeline</h3>
                    <div class="timeline-controls">
                        <button id="zoomIn" class="btn btn-secondary">üîç+</button>
                        <button id="zoomOut" class="btn btn-secondary">üîç-</button>
                        <button id="fitToScreen" class="btn btn-secondary">üìê Fit</button>
                    </div>
                </div>

                <div class="timeline-container">
                    <div class="timeline-ruler">
                        <div class="ruler-marks" id="rulerMarks">
                            <!-- Time marks will be generated here -->
                        </div>
                    </div>

                    <div class="tracks-container">
                        <!-- Video Track -->
                        <div class="track-row">
                            <div class="track-header">
                                <div class="track-info">
                                    <span class="track-icon">üé•</span>
                                    <span class="track-name">Video Track</span>
                                </div>
                                <div class="track-controls">
                                    <button class="track-btn mute-btn" data-track="0">üîá</button>
                                    <button class="track-btn lock-btn" data-track="0">üîí</button>
                                    <button class="track-btn visibility-btn" data-track="0">üëÅÔ∏è</button>
                                </div>
                            </div>
                            <div class="track-area" data-track="0" id="videoTrack">
                                <div class="track-line">
                                    <!-- Video clips will be placed here -->
                                </div>
                            </div>
                        </div>

                        <!-- Audio Track -->
                        <div class="track-row">
                            <div class="track-header">
                                <div class="track-info">
                                    <span class="track-icon">üéµ</span>
                                    <span class="track-name">Audio Track</span>
                                </div>
                                <div class="track-controls">
                                    <button class="track-btn mute-btn" data-track="1">üîá</button>
                                    <button class="track-btn lock-btn" data-track="1">üîí</button>
                                    <button class="track-btn visibility-btn" data-track="1">üëÅÔ∏è</button>
                                </div>
                            </div>
                            <div class="track-area" data-track="1" id="audioTrack">
                                <div class="track-line">
                                    <!-- Audio clips will be placed here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Playhead -->
                    <div class="playhead" id="playhead">
                        <div class="playhead-line"></div>
                        <div class="playhead-handle"></div>
                    </div>
                </div>
            </div>

            <!-- Properties Panel -->
            <div class="properties-section">
                <div class="properties-panel">
                    <h4>‚öôÔ∏è Properties</h4>
                    <div id="clipProperties" class="clip-properties">
                        <p class="placeholder-text">Select a clip to edit properties</p>
                    </div>
                    
                    <div class="project-settings">
                        <h5>Project Settings</h5>
                        <div class="setting-group">
                            <label>Resolution:</label>
                            <select id="resolution">
                                <option value="1920x1080">1920x1080 (Full HD)</option>
                                <option value="1280x720">1280x720 (HD)</option>
                                <option value="854x480">854x480 (SD)</option>
                            </select>
                        </div>
                        <div class="setting-group">
                            <label>Frame Rate:</label>
                            <select id="frameRate">
                                <option value="60">60 fps</option>
                                <option value="30">30 fps</option>
                                <option value="25">25 fps</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Modal -->
        <div id="previewModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Video Preview</h3>
                    <span class="close" onclick="closePreview()">&times;</span>
                </div>
                <div class="modal-body">
                    <video id="previewVideo" controls preload="metadata" style="width: 100%; max-width: 800px;">
                        <source src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closePreview()">Close</button>
                </div>
            </div>
        </div>

        <!-- Progress Modal -->
        <div id="progressModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="progressTitle">Processing...</h3>
                </div>
                <div class="modal-body">
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <p id="progressText">Please wait while your video is being processed.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentProject = {
            id: 'project_' + Date.now(),
            name: 'Video Project',
            tracks: [
                { 
                    id: 'video_track_1',
                    name: 'Video Track 1', 
                    type: 'video', 
                    clips: [], 
                    muted: false, 
                    locked: false, 
                    visible: true 
                },
                { 
                    id: 'audio_track_1',
                    name: 'Audio Track 1', 
                    type: 'audio', 
                    clips: [], 
                    muted: false, 
                    locked: false, 
                    visible: true 
                }
            ],
            duration: 60,
            currentTime: 0,
            playing: false,
            zoom: 1,
            videoSettings: {
                videoCodec: 'libx264',
                audioCodec: 'aac',
                crf: 23,
                preset: 'medium',
                width: 1920,
                height: 1080,
                audioBitrate: 128
            }
        };

        let uploadedFiles = [];
        let selectedClip = null;
        let isPlaying = false;
        let draggedFile = null;

        // Initialize the editor
        document.addEventListener('DOMContentLoaded', function() {
            initializeEditor();
            setupEventListeners();
            generateTimeRuler();
        });

        function initializeEditor() {
            updateTimeline();
            updateMediaLibrary();
        }

        function setupEventListeners() {
            // File upload
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');

            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileUpload);

            // Drag and drop
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleFileDrop);

            // Timeline interactions
            setupTimelineInteractions();

            // Playback controls
            document.getElementById('playBtn').addEventListener('click', togglePlayback);
            document.getElementById('stopBtn').addEventListener('click', stopPlayback);
            document.getElementById('previewBtn').addEventListener('click', generatePreview);
            document.getElementById('renderBtn').addEventListener('click', renderProject);

            // Track controls
            setupTrackControls();
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => {
                if (file.type.startsWith('video/') || file.type.startsWith('audio/')) {
                    addFileToLibrary(file);
                }
            });
        }

        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.type.startsWith('video/') || file.type.startsWith('audio/')) {
                    addFileToLibrary(file);
                }
            });
        }

        function addFileToLibrary(file) {
            // Upload file to server
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/api/timeline/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error uploading file: ' + data.error);
                    return;
                }
                
                const fileData = {
                    id: data.fileId,
                    name: data.fileName,
                    type: file.type.startsWith('video/') ? 'video' : 'audio',
                    size: file.size,
                    file: file,
                    url: URL.createObjectURL(file), // For preview
                    serverPath: data.filePath // For backend processing
                };
                uploadedFiles.push(fileData);
                updateMediaLibrary();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error uploading file: ' + error.message);
            });
        }

        function updateMediaLibrary() {
            const container = document.getElementById('mediaFiles');
            const library = document.getElementById('mediaLibrary');
            
            if (uploadedFiles.length === 0) {
                library.style.display = 'none';
                return;
            }

            library.style.display = 'block';
            container.innerHTML = '';

            uploadedFiles.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'media-file';
                fileElement.draggable = true;
                fileElement.dataset.fileId = file.id;
                
                fileElement.innerHTML = 
                    '<div class="file-preview">' +
                        (file.type === 'video' ? 
                            '<video src="' + file.url + '" muted></video>' :
                            '<div class="audio-icon">üéµ</div>') +
                    '</div>' +
                    '<div class="file-info">' +
                        '<div class="file-name">' + file.name + '</div>' +
                        '<div class="file-size">' + formatFileSize(file.size) + '</div>' +
                    '</div>' +
                    '<div class="file-actions">' +
                        '<button class="btn-small" onclick="removeFile(\'' + file.id + '\')">üóëÔ∏è</button>' +
                    '</div>';

                // Drag functionality
                fileElement.addEventListener('dragstart', (e) => {
                    draggedFile = file;
                    e.dataTransfer.effectAllowed = 'copy';
                });

                container.appendChild(fileElement);
            });
        }

        function removeFile(fileId) {
            uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
            updateMediaLibrary();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function setupTimelineInteractions() {
            const trackAreas = document.querySelectorAll('.track-area');
            
            trackAreas.forEach(area => {
                // Drop functionality
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('drag-over');
                });

                area.addEventListener('dragleave', () => {
                    area.classList.remove('drag-over');
                });

                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('drag-over');
                    
                    if (draggedFile) {
                        const trackIndex = parseInt(area.dataset.track);
                        const rect = area.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const timePosition = (x / rect.width) * currentProject.duration;
                        
                        addClipToTrack(draggedFile, trackIndex, timePosition);
                        draggedFile = null;
                    }
                });

                // Click to position playhead
                area.addEventListener('click', (e) => {
                    const rect = area.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const time = (x / rect.width) * currentProject.duration;
                    setPlayheadPosition(time);
                });
            });
        }

        function addClipToTrack(file, trackIndex, timePosition) {
            const clip = {
                id: 'clip_' + Date.now(),
                fileId: file.id,
                fileName: file.name,
                filePath: file.serverPath, // Use the server path for backend processing
                type: file.type.startsWith('video/') ? 'video' : 'audio',
                timelinePosition: timePosition,
                duration: 10, // Default duration
                startTime: 0,
                endTime: 10
            };

            currentProject.tracks[trackIndex].clips.push(clip);
            updateTimeline();
        }

        function updateTimeline() {
            const trackAreas = document.querySelectorAll('.track-area .track-line');
            
            trackAreas.forEach((area, index) => {
                const track = currentProject.tracks[index];
                area.innerHTML = '';
                
                track.clips.forEach(clip => {
                    const clipElement = document.createElement('div');
                    clipElement.className = 'clip';
                    clipElement.dataset.clipId = clip.id;
                    
                    const positionPercent = (clip.timelinePosition / currentProject.duration) * 100;
                    const widthPercent = (clip.duration / currentProject.duration) * 100;
                    
                    clipElement.style.left = positionPercent + '%';
                    clipElement.style.width = widthPercent + '%';
                    
                    clipElement.innerHTML = 
                        '<div class="clip-content">' +
                            '<span class="clip-name">' + clip.fileName + '</span>' +
                            '<div class="clip-controls">' +
                                '<button class="clip-btn" onclick="selectClip(\'' + clip.id + '\')">‚úèÔ∏è</button>' +
                                '<button class="clip-btn" onclick="deleteClip(\'' + clip.id + '\')">üóëÔ∏è</button>' +
                            '</div>' +
                        '</div>';
                    
                    clipElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectClip(clip.id);
                    });
                    
                    area.appendChild(clipElement);
                });
            });
        }

        function selectClip(clipId) {
            // Remove previous selection
            document.querySelectorAll('.clip').forEach(c => c.classList.remove('selected'));
            
            // Select new clip
            const clipElement = document.querySelector('[data-clip-id="' + clipId + '"]');
            if (clipElement) {
                clipElement.classList.add('selected');
            }
            
            selectedClip = clipId;
            updateClipProperties();
        }

        function deleteClip(clipId) {
            currentProject.tracks.forEach(track => {
                track.clips = track.clips.filter(clip => clip.id !== clipId);
            });
            updateTimeline();
            selectedClip = null;
            updateClipProperties();
        }

        function updateClipProperties() {
            const container = document.getElementById('clipProperties');
            
            if (!selectedClip) {
                container.innerHTML = '<p class="placeholder-text">Select a clip to edit properties</p>';
                return;
            }

            // Find the selected clip
            let clip = null;
            for (const track of currentProject.tracks) {
                clip = track.clips.find(c => c.id === selectedClip);
                if (clip) break;
            }

            if (!clip) return;

            container.innerHTML = 
                '<div class="clip-properties-content">' +
                    '<h5>Clip Properties</h5>' +
                    '<div class="property-group">' +
                        '<label>File:</label>' +
                        '<span>' + clip.fileName + '</span>' +
                    '</div>' +
                    '<div class="property-group">' +
                        '<label>Timeline Position (s):</label>' +
                        '<input type="number" id="clipPosition" value="' + clip.timelinePosition.toFixed(2) + '" step="0.01" min="0">' +
                    '</div>' +
                    '<div class="property-group">' +
                        '<label>Start (s):</label>' +
                        '<input type="number" id="clipStart" value="' + clip.startTime.toFixed(2) + '" step="0.01" min="0">' +
                    '</div>' +
                    '<div class="property-group">' +
                        '<label>Length (s):</label>' +
                        '<input type="number" id="clipLength" value="' + (clip.endTime - clip.startTime).toFixed(2) + '" step="0.01" min="0.01">' +
                    '</div>' +
                    '<div class="property-group">' +
                        '<label>Speed:</label>' +
                        '<input type="number" id="clipSpeed" value="' + (clip.speed ? clip.speed.toFixed(2) : '1.00') + '" step="0.01" min="0.1" max="10">' +
                    '</div>' +
                    '<div class="property-actions">' +
                        '<button class="btn btn-primary btn-small" onclick="updateClipViewProperties()">Update</button>' +
                    '</div>' +
                '</div>';
        }

        function updateClipViewProperties() {
            if (!selectedClip) return;

            const position = parseFloat(document.getElementById('clipPosition').value);
            const start = parseFloat(document.getElementById('clipStart').value);
            const length = parseFloat(document.getElementById('clipLength').value);
            const speed = parseFloat(document.getElementById('clipSpeed').value);

            // Find and update the clip
            for (const track of currentProject.tracks) {
                const clip = track.clips.find(c => c.id === selectedClip);
                if (clip) {
                    clip.timelinePosition = position;
                    clip.startTime = start;
                    clip.endTime = start + length;
                    clip.speed = speed;
                    clip.duration = length / (speed > 0 ? speed : 1.0);
                    break;
                }
            }

            updateTimeline();
        }

        function generateTimeRuler() {
            const container = document.getElementById('rulerMarks');
            const marks = [];
            
            for (let i = 0; i <= currentProject.duration; i += 5) {
                marks.push('<div class="time-mark" style="left: ' + ((i / currentProject.duration) * 100) + '%">' + i + 's</div>');
            }
            
            container.innerHTML = marks.join('');
        }

        function setPlayheadPosition(time) {
            const playhead = document.getElementById('playhead');
            const percentage = (time / currentProject.duration) * 100;
            playhead.style.left = percentage + '%';
            currentProject.currentTime = time;
        }

        function setupTrackControls() {
            document.querySelectorAll('.mute-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const trackIndex = parseInt(e.target.dataset.track);
                    const track = currentProject.tracks[trackIndex];
                    track.muted = !track.muted;
                    e.target.textContent = track.muted ? 'üîä' : 'üîá';
                });
            });

            document.querySelectorAll('.lock-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const trackIndex = parseInt(e.target.dataset.track);
                    const track = currentProject.tracks[trackIndex];
                    track.locked = !track.locked;
                    e.target.textContent = track.locked ? 'üîì' : 'üîí';
                });
            });

            document.querySelectorAll('.visibility-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const trackIndex = parseInt(e.target.dataset.track);
                    const track = currentProject.tracks[trackIndex];
                    track.visible = !track.visible;
                    e.target.textContent = track.visible ? 'üëÅÔ∏è' : 'üôà';
                });
            });
        }

        function togglePlayback() {
            if (isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }

        function startPlayback() {
            isPlaying = true;
            document.getElementById('playBtn').textContent = '‚è∏Ô∏è Pause';
            // In a real implementation, you would start video playback here
        }

        function stopPlayback() {
            isPlaying = false;
            document.getElementById('playBtn').textContent = '‚ñ∂Ô∏è Play';
            setPlayheadPosition(0);
        }

        function generatePreview() {
            if (!currentProject.tracks.some(track => track.clips.length > 0)) {
                alert('Please add some clips to the timeline first!');
                return;
            }

            showProgressModal('Generating Preview...', 'Creating a preview of your timeline...');
            
            // Call the backend API to generate preview
            fetch('/api/timeline/preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(currentProject)
            })
            .then(response => response.json())
            .then(data => {
                hideProgressModal();
                if (data.error) {
                    alert('Error generating preview: ' + data.error);
                } else {
                    showPreview(data.previewPath);
                }
            })
            .catch(error => {
                hideProgressModal();
                console.error('Error:', error);
                alert('Error generating preview: ' + error.message);
            });
        }

        function renderProject() {
            if (!currentProject.tracks.some(track => track.clips.length > 0)) {
                alert('Please add some clips to the timeline first!');
                return;
            }

            showProgressModal('Rendering Video...', 'Processing your timeline and creating the final video...');
            
            // Simulate rendering
            setTimeout(() => {
                hideProgressModal();
                alert('Video rendered successfully! You can download it from the output directory.');
            }, 5000);
        }

        function showPreview(previewPath) {
            const modal = document.getElementById('previewModal');
            const video = document.getElementById('previewVideo');
            
            if (previewPath) {
                const videoUrl = '/download/' + previewPath.split('/').pop();
                video.src = videoUrl;
                
                // Add error handling
                video.onerror = function() {
                    console.error('Error loading video:', videoUrl);
                    alert('Error loading preview video. The video format may not be supported by your browser.');
                };
                
                video.onloadeddata = function() {
                    console.log('Video loaded successfully:', videoUrl);
                };
            }
            
            modal.style.display = 'block';
        }

        function closePreview() {
            const modal = document.getElementById('previewModal');
            const video = document.getElementById('previewVideo');
            
            modal.style.display = 'none';
            video.src = '';
            video.pause();
        }

        function showProgressModal(title, text) {
            document.getElementById('progressTitle').textContent = title;
            document.getElementById('progressText').textContent = text;
            document.getElementById('progressModal').style.display = 'block';
        }

        function hideProgressModal() {
            document.getElementById('progressModal').style.display = 'none';
        }

        // Modal close on outside click
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                closePreview();
                hideProgressModal();
            }
        });
    </script>
</body>
</html>